# ajax 点击加载更多


### `index.html`
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="http://libs.baidu.com/jquery/2.1.4/jquery.min.js"></script>
</head>
<body>

<a href="#" id="more">...加载更多</a>

<script>
    String.prototype.format = function () {
        if (arguments.length === 0) return this;
        var param = arguments[0], str = this;
        if (typeof (param) === 'object') {
            for (var key in param)
                str = str.replace(new RegExp("\\{" + key + "\\}", "g"), param[key]);
            return str;
        } else {
            for (var i = 0; i < arguments.length; i++)
                str = str.replace(new RegExp("\\{" + i + "\\}", "g"), arguments[i]);
            return str;
        }
    };

     //offset:是需要传给后台的参数，用于获取评论的参数，评论的偏移量，
    // 此请求应该从索引为2的位置开始获取，默认索引为0,1的评论已经展示过了。
    var offset = 0;
    $('#more').click(function () {
        offset += 2;
        $('input[name="offset"]').val(offset);
        $.ajax({
            url: '{% url 'more' %}',
            data: {'offset': offset,},
            success: function (data) {
                var sum = data.length;

                 //data这个参数是后台返回的数据，此时后台需要返回JSON字符串；
                // 并将相应的结果展示在页面中。
                {#console.log(data,status)#}
                var comments = data['comments'];
                for (var i = 0; i < comments.length; i++) {
                    //利用i为索引,从comments数组中获取对应的评论内容
                    var comment = comments[i];
                    //利用js向页面中插入两条评论
                    result = '<div class=""><p>{content}</p></div><hr>'.format(comment);
                    //$(this)指的就是$('more'),表示获取当前操作的对象。
                    // before():指的就是在当前元素前面追加两个元素
                    $('#more').before(result);
                }
                /*隐藏more按钮*/
                console.log(offset);
                console.log(comments.length);
                if (2 > comments.length) {
                    $("#more").hide();
                } else {
                    $("#more").show();
                }
            }
        });
        {# return false:阻止a标签的默认的GET请求事件。 #}
        return false;

    })
</script>
</body>
</html>

```

### `views.py`
```python
from django.http import HttpResponse,JsonResponse


def index(request):
    articles = Question.objects.all()
    resposne = render(request,'index.html')
    resposne.set_cookie('offset',2)
    return resposne

def more(request):
    # 获取前端传过来的评论偏移量
    offset = int(request.GET.get('offset'))
    # 根据这个偏移量查询出来两条数据
    comments = Question.objects.all()[offset-2:offset]
    print(comments)
    # 将要展示的评论转换成json字符串，返回给前端。{'comments':[{评论id,评论内容...},{},{}]}
    comments_dict={}
    comments_list = []
    for comment in comments:
        dic = {}
        dic['content'] = comment.question_text
        comments_list.append(dic)

    comments_dict['comments'] = comments_list
    response = JsonResponse(comments_dict)
    response.set_cookie('offset',offset)
    return response

```


### `urls.py`
```python
from myapp import views

urlpatterns = [
    path('' ,views.index),
    path('more',views.more,name='more'),
]
```

### `models.py`

```python
class Question(models.Model):
    question_text = models.CharField(max_length=200,verbose_name='提问')
    pub_date = models.DateTimeField('date published')
```